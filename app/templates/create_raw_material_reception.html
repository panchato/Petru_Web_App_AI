{% extends 'base.html' %}
{% block content %}
<div class="page-header">
    <div>
        <h2>Recepci&oacute;n de materia prima</h2>
        <p class="subtle">Paso 1: registra los datos de la recepci&oacute;n.</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('materiaprima.list_rmrs') }}" class="btn btn-outline-secondary">Volver al listado</a>
    </div>
</div>

<div class="form-section">
<form method="POST">
    {{ form.hidden_tag() }}
    <div class="row g-3">
        <div class="col-md-6">
            {{ form.client_id.label(class="form-label required") }}
            <input type="text" class="form-control mb-2" id="clientSearch" placeholder="Buscar cliente...">
            {{ form.client_id(class="form-select", aria_describedby="reception_client_error") }}
            {% if form.client_id.errors %}
            <div id="reception_client_error" class="field-error" role="alert">{{ form.client_id.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {{ form.grower_id.label(class="form-label required") }}
            <input type="text" class="form-control mb-2" id="growerSearch" placeholder="Buscar productor...">
            {{ form.grower_id(class="form-select", aria_describedby="reception_grower_error") }}
            {% if form.grower_id.errors %}
            <div id="reception_grower_error" class="field-error" role="alert">{{ form.grower_id.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {{ form.waybill.label(class="form-label required") }}
            {{ form.waybill(class="form-control", aria_describedby="reception_waybill_error") }}
            {% if form.waybill.errors %}
            <div id="reception_waybill_error" class="field-error" role="alert">{{ form.waybill.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ form.date.label(class="form-label required") }}
            {{ form.date(class="form-control", aria_describedby="reception_date_error") }}
            {% if form.date.errors %}
            <div id="reception_date_error" class="field-error" role="alert">{{ form.date.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-3">
            {{ form.time.label(class="form-label required") }}
            {{ form.time(class="form-control", aria_describedby="reception_time_error") }}
            {% if form.time.errors %}
            <div id="reception_time_error" class="field-error" role="alert">{{ form.time.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {{ form.truck_plate.label(class="form-label") }}
            {{ form.truck_plate(class="form-control", placeholder="ABCD12 o AB1234", aria_describedby="reception_plate_error") }}
            {% if form.truck_plate.errors %}
            <div id="reception_plate_error" class="field-error" role="alert">{{ form.truck_plate.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {{ form.trucker_name.label(class="form-label") }}
            {{ form.trucker_name(class="form-control", aria_describedby="reception_trucker_error") }}
            {% if form.trucker_name.errors %}
            <div id="reception_trucker_error" class="field-error" role="alert">{{ form.trucker_name.errors[0] }}</div>
            {% endif %}
        </div>
        <div class="col-12">
            {{ form.observations.label(class="form-label") }}
            {{ form.observations(class="form-control", rows="3", aria_describedby="reception_obs_error") }}
            {% if form.observations.errors %}
            <div id="reception_obs_error" class="field-error" role="alert">{{ form.observations.errors[0] }}</div>
            {% endif %}
        </div>
    </div>
    <div class="page-actions mt-4">
        {{ form.submit(class="btn btn-primary") }}
        <a href="{{ url_for('materiaprima.list_rmrs') }}" class="btn btn-outline-secondary">Cancelar</a>
    </div>
</form>
</div>

{% if reception_id %}
<div class="alert alert-success d-flex flex-wrap justify-content-between align-items-center mt-4">
    <div>Recepci&oacute;n creada correctamente.</div>
    <div class="page-actions">
        <a href="{{ url_for('materiaprima.create_lot', reception_id=reception_id) }}" class="btn btn-primary btn-sm">Crear lote</a>
    </div>
</div>
{% endif %}

<script>
    (function () {
        function bindSearch(searchId, selectId) {
            var search = document.getElementById(searchId);
            var select = document.getElementById(selectId);
            if (!search || !select) return;

            var originalOptions = Array.from(select.options).map(function (option) {
                return { value: option.value, text: option.text, selected: option.selected };
            });

            function render(filterText) {
                var selectedValue = select.value;
                var normalized = (filterText || '').toLowerCase().trim();
                select.innerHTML = '';
                originalOptions.forEach(function (item) {
                    if (!normalized || item.text.toLowerCase().indexOf(normalized) !== -1) {
                        var opt = document.createElement('option');
                        opt.value = item.value;
                        opt.text = item.text;
                        opt.selected = item.value === selectedValue || (item.selected && !selectedValue);
                        select.appendChild(opt);
                    }
                });
            }

            search.addEventListener('input', function () { render(search.value); });
        }

        bindSearch('clientSearch', 'client_id');
        bindSearch('growerSearch', 'grower_id');
    })();
</script>

{% endblock %}
