<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Operacional - PETRU</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        }

        .dashboard-tv {
            min-height: 100vh;
            padding: 16px;
            display: grid;
            grid-template-rows: auto auto auto auto;
            align-content: start;
            gap: 10px;
        }

        .tv-header {
            display: flex;
            justify-content: space-between;
            align-items: end;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }

        .tv-header h1 {
            margin: 0;
            font-size: clamp(1.6rem, 2.8vw, 2.3rem);
            line-height: 1.1;
        }

        .tv-meta {
            color: #5f6972;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .health-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 0.8rem;
            background: #f6f8fa;
            color: #4f5b66;
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            background: #2f7d52;
        }

        .health-chip.stale .health-dot {
            background: #b02a37;
        }

        .health-chip.stale {
            color: #7b1e25;
            border-color: #e4c5c5;
            background: #fff6f6;
        }

        .section-title {
            margin: 2px 0 0;
            color: #5f6972;
            font-size: 0.84rem;
            text-transform: uppercase;
            letter-spacing: 0.055em;
            font-weight: 700;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .kpi-card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            padding: 14px;
            box-shadow: 0 1px 2px rgba(22, 26, 30, 0.04);
        }

        .kpi-label {
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 0.74rem;
            color: #5f6972;
            font-weight: 700;
        }

        .kpi-value {
            margin: 8px 0 0;
            font-size: clamp(3.1rem, 6vw, 4.8rem);
            line-height: 1;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 8px;
            color: #505860;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            gap: 10px;
        }

        .status-card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
            padding: 11px 12px;
        }

        .status-value {
            margin: 8px 0 0;
            font-size: clamp(1.9rem, 4vw, 2.7rem);
            line-height: 1;
            font-weight: 700;
            display: flex;
            align-items: baseline;
            gap: 6px;
            color: #4f5861;
        }

        .value-unit {
            font-size: 0.33em;
            color: #62707c;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 10px;
            align-items: start;
        }

        .alert-card {
            border: 1px solid #d9e0e7;
            border-left: 5px solid #8d99a6;
            border-radius: var(--radius);
            background: #f8fafc;
            padding: 12px;
            min-height: 0;
        }

        .alert-title {
            margin: 0;
            font-size: 0.88rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: #5f6972;
            font-weight: 700;
        }

        .alert-value {
            margin: 8px 0 0;
            font-size: clamp(2rem, 4.1vw, 2.8rem);
            line-height: 1;
            font-weight: 700;
            color: #58636f;
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .alert-card.has-alert {
            border-color: #e4c5c5;
            border-left-color: var(--danger);
            background: #fff8f8;
        }

        .alert-card.has-alert .alert-title {
            color: #7b1e25;
        }

        .alert-card.has-alert .alert-value {
            color: var(--danger);
        }

        @media (max-width: 950px) {
            .status-grid,
            .alerts-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 680px) {
            .kpi-grid,
            .status-grid,
            .alerts-grid {
                grid-template-columns: 1fr;
            }

            .tv-header {
                flex-direction: column;
                align-items: start;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <main class="dashboard-tv">
        <section class="tv-header">
            <h1>Panel Operacional PETRU</h1>
            <div class="tv-meta">
                <span id="dashboard-updated">Actualizado: --</span>
                <span class="health-chip" id="data-health"><span class="health-dot"></span><span id="data-health-text">al día</span></span>
            </div>
        </section>

        <p class="section-title">Hoy</p>
        <section class="kpi-grid" aria-label="KPI de hoy">
            <article class="kpi-card">
                <p class="kpi-label">Lotes recibidos hoy</p>
                <p class="kpi-value"><span id="kpi-lots-today">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="kpi-card">
                <p class="kpi-label">Kilogramos recibidos hoy</p>
                <p class="kpi-value"><span id="kpi-kg-today">0,00</span><span class="value-unit">kg</span></p>
            </article>
        </section>

        <p class="section-title">Fumigación</p>
        <section class="status-grid" aria-label="Estado fumigación">
            <article class="status-card">
                <span class="status-badge status-available">Disponible</span>
                <p class="status-value"><span id="status-available">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="status-card">
                <span class="status-badge status-assigned">Asignada</span>
                <p class="status-value"><span id="status-assigned">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="status-card">
                <span class="status-badge status-active">En fumigación</span>
                <p class="status-value"><span id="status-started">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="status-card">
                <span class="status-badge status-done">Finalizada</span>
                <p class="status-value"><span id="status-completed">0</span><span class="value-unit">lotes</span></p>
            </article>
        </section>

        <p class="section-title">Alertas</p>
        <section class="alerts-grid" aria-label="Alertas operacionales">
            <article class="alert-card" data-alert-key="no_qc_over_24h">
                <p class="alert-title">Sin QC &gt; 24 horas</p>
                <p class="alert-value"><span id="alert-no-qc">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="alert-card" data-alert-key="missing_net_weight_over_12h">
                <p class="alert-title">Sin peso neto &gt; 12 horas</p>
                <p class="alert-value"><span id="alert-no-weight">0</span><span class="value-unit">lotes</span></p>
            </article>
            <article class="alert-card" data-alert-key="no_fumigation_over_48h">
                <p class="alert-title">Sin fumigación &gt; 48 horas</p>
                <p class="alert-value"><span id="alert-no-fumigation">0</span><span class="value-unit">lotes</span></p>
            </article>
        </section>
    </main>

    <script>
        const intFormatter = new Intl.NumberFormat("es-CL");
        const kgFormatter = new Intl.NumberFormat("es-CL", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function getAlertByKey(alerts, key) {
            return (alerts || []).find((item) => item.key === key) || { count: 0 };
        }

        function updateAlertCardState(alertKey, count) {
            const card = document.querySelector(`[data-alert-key="${alertKey}"]`);
            if (!card) {
                return;
            }
            card.classList.toggle("has-alert", count > 0);
            card.style.order = String(-(count || 0));
        }

        function updateDataHealth(generatedAt) {
            const healthChip = document.getElementById("data-health");
            const healthText = document.getElementById("data-health-text");
            const generated = generatedAt ? new Date(generatedAt) : null;
            const ageSeconds = generated ? Math.floor((Date.now() - generated.getTime()) / 1000) : Number.POSITIVE_INFINITY;
            const isStale = !Number.isFinite(ageSeconds) || ageSeconds > 120;
            healthChip.classList.toggle("stale", isStale);
            healthText.textContent = isStale ? "desactualizado" : "al día";
        }

        async function refreshDashboard() {
            const response = await fetch("/api/dashboard/summary", { cache: "no-store" });
            const data = await response.json();

            document.getElementById("kpi-lots-today").textContent = intFormatter.format(data.today?.lots_received || 0);
            document.getElementById("kpi-kg-today").textContent = kgFormatter.format(data.today?.kilograms_received || 0);

            const statusMap = {};
            (data.fumigation_status || []).forEach((item) => {
                statusMap[item.key] = item.count;
            });
            document.getElementById("status-available").textContent = intFormatter.format(statusMap.AVAILABLE || 0);
            document.getElementById("status-assigned").textContent = intFormatter.format(statusMap.ASSIGNED || 0);
            document.getElementById("status-started").textContent = intFormatter.format(statusMap.STARTED || 0);
            document.getElementById("status-completed").textContent = intFormatter.format(statusMap.COMPLETED || 0);

            const alertNoQc = getAlertByKey(data.alerts, "no_qc_over_24h");
            const alertNoWeight = getAlertByKey(data.alerts, "missing_net_weight_over_12h");
            const alertNoFumigation = getAlertByKey(data.alerts, "no_fumigation_over_48h");

            document.getElementById("alert-no-qc").textContent = intFormatter.format(alertNoQc.count || 0);
            document.getElementById("alert-no-weight").textContent = intFormatter.format(alertNoWeight.count || 0);
            document.getElementById("alert-no-fumigation").textContent = intFormatter.format(alertNoFumigation.count || 0);

            updateAlertCardState("no_qc_over_24h", alertNoQc.count || 0);
            updateAlertCardState("missing_net_weight_over_12h", alertNoWeight.count || 0);
            updateAlertCardState("no_fumigation_over_48h", alertNoFumigation.count || 0);

            document.getElementById("dashboard-updated").textContent = `Actualizado: ${new Date().toLocaleString()}`;
            updateDataHealth(data.generated_at);
        }

        window.addEventListener("DOMContentLoaded", async () => {
            await refreshDashboard();
            setInterval(refreshDashboard, 60000);
        });
    </script>
</body>
</html>
