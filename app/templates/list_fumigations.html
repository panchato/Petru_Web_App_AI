{% extends "base.html" %}
{% block content %}
<div class="container">
<div class="page-header">
    <div>
        <h2>Listado de fumigaciones</h2>
        <p class="subtle">Controla el estado, documentos y pr&oacute;ximas acciones.</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('create_fumigation') }}" class="btn btn-primary">Crear fumigaci&oacute;n</a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">Inicio</a>
    </div>
</div>

<form class="filters" method="GET" action="{{ url_for('list_fumigations') }}" aria-label="Filtros r&aacute;pidos de fumigaciones">
    <div>
        <label class="form-label">Estado</label>
        <select class="form-select" name="status">
            <option value="">Todos</option>
            <option value="asignada" {% if filters.status == 'asignada' %}selected{% endif %}>Asignada</option>
            <option value="en_fumigacion" {% if filters.status == 'en_fumigacion' %}selected{% endif %}>En fumigaci&oacute;n</option>
            <option value="finalizada" {% if filters.status == 'finalizada' %}selected{% endif %}>Finalizada</option>
        </select>
    </div>
    <div>
        <label class="form-label">Orden de trabajo</label>
        <input type="text" class="form-control" name="work_order" placeholder="Buscar OT" value="{{ filters.work_order }}">
    </div>
    <div>
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" name="date_from" value="{{ filters.date_from }}">
    </div>
    <div>
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" name="date_to" value="{{ filters.date_to }}">
    </div>
    <div>
        <label class="form-label">Orden</label>
        <select class="form-select" name="sort">
            <option value="created_desc" {% if filters.sort == 'created_desc' %}selected{% endif %}>M&aacute;s recientes</option>
            <option value="start_date_desc" {% if filters.sort == 'start_date_desc' %}selected{% endif %}>Inicio descendente</option>
            <option value="start_date_asc" {% if filters.sort == 'start_date_asc' %}selected{% endif %}>Inicio ascendente</option>
            <option value="work_order_asc" {% if filters.sort == 'work_order_asc' %}selected{% endif %}>OT A-Z</option>
        </select>
    </div>
    <div>
        <button type="submit" class="btn btn-primary">Aplicar</button>
    </div>
    <div>
        <a class="btn btn-outline-secondary" href="{{ url_for('list_fumigations') }}">Limpiar</a>
    </div>
</form>

<div class="table-responsive">
<table class="table table-striped table-searchable">
    <thead>
        <tr>
            <th>Orden de Trabajo</th>
            <th>Lotes</th>
            <th>Estado</th>
            <th>Acciones</th>
            <th>Documentos</th>
        </tr>
    </thead>
    <tbody>
        {% for fumigation in fumigations %}
        {% if fumigation.real_end_date is not none %}
            {% set status_key = 'finalizada' %}
            {% set status_label = 'Finalizada' %}
        {% elif fumigation.lots|selectattr('fumigation_status', 'equalto', '3')|list|length > 0 %}
            {% set status_key = 'en_fumigacion' %}
            {% set status_label = 'En fumigaci&oacute;n' %}
        {% elif fumigation.lots|selectattr('fumigation_status', 'equalto', '2')|list|length > 0 %}
            {% set status_key = 'asignada' %}
            {% set status_label = 'Asignada' %}
        {% else %}
            {% set status_key = 'desconocida' %}
            {% set status_label = 'Desconocida' %}
        {% endif %}
        <tr data-status="{{ status_key }}" data-order="{{ fumigation.work_order }}" data-date="{{ fumigation.real_start_date.isoformat() if fumigation.real_start_date else '' }}">
            <td>{{ fumigation.work_order }}</td>
            <td>
                {% for lot in fumigation.lots %}
                    Lote {{ '{:03}'.format(lot.lot_number) }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                <span class="status-badge {% if status_key == 'finalizada' %}status-done{% elif status_key == 'en_fumigacion' %}status-active{% elif status_key == 'asignada' %}status-assigned{% else %}status-unknown{% endif %}">
                    {{ status_label }}
                </span>
            </td>
            <td>
                {% if fumigation.real_end_date is none and fumigation.lots|selectattr('fumigation_status', 'equalto', '2')|list|length > 0 %}
                    <a href="{{ url_for('start_fumigation', fumigation_id=fumigation.id) }}" class="btn btn-sm btn-primary">Iniciar</a>
                {% elif fumigation.lots|selectattr('fumigation_status', 'equalto', '3')|list|length > 0 %}
                    <a href="{{ url_for('complete_fumigation', fumigation_id=fumigation.id) }}" class="btn btn-sm btn-primary">Completar</a>
                {% endif %}
            </td>
            <td>
                {% if fumigation.lots|selectattr('fumigation_status', 'equalto', '3')|list|length > 0 %}
                    {% if fumigation.fumigation_sign_path %}
                        <a href="{{ url_for('view_fumigation_document', fumigation_id=fumigation.id, document_kind='sign') }}" target="_blank" class="btn btn-outline-dark btn-sm">Cartel</a>
                    {% endif %}
                    {% if fumigation.work_order_path %}
                        <a href="{{ url_for('view_fumigation_document', fumigation_id=fumigation.id, document_kind='work_order') }}" target="_blank" class="btn btn-outline-dark btn-sm">OT</a>
                    {% endif %}
                {% elif fumigation.real_end_date is not none %}
                    {% if fumigation.fumigation_sign_path %}
                        <a href="{{ url_for('view_fumigation_document', fumigation_id=fumigation.id, document_kind='sign') }}" target="_blank" class="btn btn-outline-success btn-sm">Cartel</a>
                    {% endif %}
                    {% if fumigation.work_order_path %}
                        <a href="{{ url_for('view_fumigation_document', fumigation_id=fumigation.id, document_kind='work_order') }}" target="_blank" class="btn btn-outline-success btn-sm">OT</a>
                    {% endif %}
                    {% if fumigation.certificate_path %}
                        <a href="{{ url_for('view_fumigation_document', fumigation_id=fumigation.id, document_kind='certificate') }}" target="_blank" class="btn btn-outline-success btn-sm">Certificado</a>
                    {% endif %}
                {% endif %}
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="5">
                <div class="empty-state">
                    <div>No se encontraron fumigaciones en la base de datos.</div>
                    <a href="{{ url_for('create_fumigation') }}" class="btn btn-primary btn-sm">Crear fumigaci&oacute;n</a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
</div>
{% include "_pagination.html" %}
</div>
{% endblock %}
