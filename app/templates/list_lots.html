{% extends "base.html" %}
{% block content %}
<div class="page-header">
    <div>
        <h2>Listado de lotes</h2>
        <p class="subtle">Consulta estado, peso y documentos asociados.</p>
    </div>
    <div class="page-actions">
        <a href="{{ url_for('materiaprima.create_raw_material_reception') }}" class="btn btn-primary">Crear recepci&oacute;n</a>
        <a href="{{ url_for('materiaprima.list_rmrs') }}" class="btn btn-outline-secondary">Ver recepciones</a>
    </div>
</div>

{% if labels_url %}
<div class="alert alert-success d-flex flex-wrap justify-content-between align-items-center">
    <div>Etiquetas generadas correctamente.</div>
    <div class="page-actions">
        <a href="{{ labels_url }}" target="_blank" class="btn btn-primary btn-sm">Descargar etiquetas</a>
    </div>
</div>
{% endif %}

{% if active_alert %}
<div class="alert alert-warning d-flex flex-wrap justify-content-between align-items-center">
    <div>Filtro operacional activo: {{ active_alert.label }}</div>
    <div class="page-actions">
        <a href="{{ url_for('materiaprima.list_lots') }}" class="btn btn-outline-secondary btn-sm">Quitar filtro</a>
    </div>
</div>
{% endif %}

<form class="filters" method="GET" action="{{ url_for('materiaprima.list_lots') }}" aria-label="Filtros r&aacute;pidos de lotes">
    {% if active_alert %}
    <input type="hidden" name="alert" value="{{ active_alert.key }}">
    {% endif %}
    {% if labels_url %}
    <input type="hidden" name="labels_url" value="{{ labels_url }}">
    {% endif %}
    <div>
        <label class="form-label">Estado fumigaci&oacute;n</label>
        <select class="form-select" name="status">
            <option value="">Todos</option>
            <option value="disponible" {% if filters.status == 'disponible' %}selected{% endif %}>Disponible</option>
            <option value="asignada" {% if filters.status == 'asignada' %}selected{% endif %}>Asignada</option>
            <option value="en_fumigacion" {% if filters.status == 'en_fumigacion' %}selected{% endif %}>En fumigaci&oacute;n</option>
            <option value="finalizada" {% if filters.status == 'finalizada' %}selected{% endif %}>Finalizada</option>
        </select>
    </div>
    <div>
        <label class="form-label">Cliente</label>
        <input type="text" class="form-control" name="client" placeholder="Buscar cliente" value="{{ filters.client }}">
    </div>
    <div>
        <label class="form-label">Productor</label>
        <input type="text" class="form-control" name="grower" placeholder="Buscar productor" value="{{ filters.grower }}">
    </div>
    <div>
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" name="date_from" value="{{ filters.date_from }}">
    </div>
    <div>
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" name="date_to" value="{{ filters.date_to }}">
    </div>
    <div>
        <label class="form-label">Orden</label>
        <select class="form-select" name="sort">
            <option value="lot_number_asc" {% if filters.sort == 'lot_number_asc' %}selected{% endif %}>Lote ascendente</option>
            <option value="lot_number_desc" {% if filters.sort == 'lot_number_desc' %}selected{% endif %}>Lote descendente</option>
            <option value="created_desc" {% if filters.sort == 'created_desc' %}selected{% endif %}>M&aacute;s recientes</option>
            <option value="created_asc" {% if filters.sort == 'created_asc' %}selected{% endif %}>M&aacute;s antiguos</option>
        </select>
    </div>
    <div>
        <button type="submit" class="btn btn-primary">Aplicar</button>
    </div>
    <div>
        <a class="btn btn-outline-secondary" href="{{ url_for('materiaprima.list_lots', alert=active_alert.key if active_alert else None, labels_url=labels_url if labels_url else None) }}">Limpiar</a>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped" id="lotsTable">
        <thead>
            <tr>
                <th>N&ordm; Lote</th>
                <th>Cliente</th>
                <th>Productor</th>
                <th>Variedad</th>
                <th>Estado fumigaci&oacute;n</th>
                <th>Peso neto</th>
                <th class="actions">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for lot in lots %}
            {% set client_names = [] %}
            {% for client in lot.raw_material_reception.clients %}
                {% set _ = client_names.append(client.name) %}
            {% endfor %}
            {% set grower_names = [] %}
            {% for grower in lot.raw_material_reception.growers %}
                {% set _ = grower_names.append(grower.name) %}
            {% endfor %}
            {% if lot.fumigation_status == '1' %}
                {% set status_key = 'disponible' %}
                {% set status_label = 'Disponible' %}
            {% elif lot.fumigation_status == '2' %}
                {% set status_key = 'asignada' %}
                {% set status_label = 'Asignada' %}
            {% elif lot.fumigation_status == '3' %}
                {% set status_key = 'en_fumigacion' %}
                {% set status_label = 'En fumigaci&oacute;n' %}
            {% elif lot.fumigation_status == '4' %}
                {% set status_key = 'finalizada' %}
                {% set status_label = 'Finalizada' %}
            {% else %}
                {% set status_key = 'desconocida' %}
                {% set status_label = 'Desconocida' %}
            {% endif %}
            <tr data-status="{{ status_key }}"
                data-client="{{ client_names|join(', ') }}"
                data-grower="{{ grower_names|join(', ') }}"
                data-date="{{ lot.raw_material_reception.date.isoformat() if lot.raw_material_reception.date else '' }}">
                <td>{{ '%03d' % lot.lot_number }}</td>
                <td>{{ client_names|join(', ') if client_names else 'N/A' }}</td>
                <td>{{ grower_names|join(', ') if grower_names else 'N/A' }}</td>
                <td>{{ lot.variety.name }}</td>
                <td>
                    <span class="status-badge {% if status_key == 'disponible' %}status-available{% elif status_key == 'asignada' %}status-assigned{% elif status_key == 'en_fumigacion' %}status-active{% elif status_key == 'finalizada' %}status-done{% else %}status-unknown{% endif %}">
                        {{ status_label }}
                    </span>
                </td>
                <td>
                    {% if lot.net_weight is none or lot.net_weight == 0 %}
                    <span class="status-badge status-unknown">Pendiente</span>
                    {% else %}
                    {{ lot.net_weight }}
                    {% endif %}
                </td>
                <td class="actions">
                    {% if (lot.net_weight is none or lot.net_weight == 0) and (current_user.has_role('Admin') or (current_user.from_area('Materia Prima') and current_user.has_role('Contribuidor'))) %}
                    {% set next_url = url_for('materiaprima.list_lots') + ('?' + current_query_string if current_query_string else '') %}
                    <form method="POST" action="{{ url_for('materiaprima.update_lot_weight_inline', lot_id=lot.id) }}" class="inline-weight-form">
                        {{ csrf_form.hidden_tag() }}
                        <input type="hidden" name="next" value="{{ next_url }}">
                        <div class="inline-weight-grid">
                            <input type="number" step="0.01" min="0" name="loaded_truck_weight" class="form-control form-control-sm" placeholder="Cargado" required data-inline-loaded>
                            <input type="number" step="0.01" min="0" name="empty_truck_weight" class="form-control form-control-sm" placeholder="VacÃ­o" required data-inline-empty>
                        </div>
                        <div class="form-help" data-inline-preview data-tare="{{ lot.raw_material_packaging.tare if lot.raw_material_packaging else 0 }}" data-quantity="{{ lot.packagings_quantity }}">Neto: 0,00 kg</div>
                        <button type="submit" class="btn btn-sm btn-primary mt-2">Guardar peso</button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('materiaprima.lot_labels_pdf', lot_id=lot.id) }}" class="btn btn-sm btn-outline-secondary" target="_blank">Etiquetas</a>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">
                    <div class="empty-state">
                        <div>No se encontraron lotes en la base de datos.</div>
                        <a href="{{ url_for('materiaprima.create_raw_material_reception') }}" class="btn btn-primary btn-sm">Crear recepci&oacute;n</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% include "_pagination.html" %}
<script src="{{ url_for('static', filename='js/weight-preview.js') }}"></script>
<script>
    (function () {
        if (!window.WeightPreview) {
            return;
        }
        window.WeightPreview.bindInlineForms({
            formSelector: '.inline-weight-form',
            loadedSelector: '[data-inline-loaded]',
            emptySelector: '[data-inline-empty]',
            previewSelector: '[data-inline-preview]',
            locale: 'es-CL'
        });
    })();
</script>
{% endblock %}

